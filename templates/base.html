<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cubie NAS</title>
  <link rel="stylesheet" href="/static/css/style.css?v=20260220a" />
</head>
<body data-page="{{ page }}">
  <div class="layout">
    <aside class="sidebar">
      <div class="brand">
        <div class="badge">NAS</div>
        <div>
          <h1>Cubie NAS</h1>
          <p>Device Management</p>
        </div>
      </div>
      <nav>
        <div class="nav-group">
          <p class="nav-group-title">Consumer</p>
          <a href="/overview" class="nav-link {% if page == 'overview' %}active{% endif %}">Dashboard</a>
          <a href="/files" class="nav-link {% if page == 'files' %}active{% endif %}">Files</a>
          <a href="/sharing" class="nav-link {% if page == 'sharing' %}active{% endif %}">Sharing</a>
          <a href="/users" class="nav-link {% if page == 'users' %}active{% endif %}">Users</a>
          <a href="/settings" class="nav-link {% if page == 'settings' %}active{% endif %}">Settings</a>
        </div>

        <button type="button" class="advanced-toggle" id="advanced-toggle" aria-expanded="false" aria-controls="advanced-nav">
          <span>Advanced</span>
          <span id="advanced-chevron">▸</span>
        </button>

        <div class="nav-group advanced-nav" id="advanced-nav" hidden>
          <a href="/nas" class="nav-link {% if page == 'nas' %}active{% endif %}">NAS ⚡</a>
          <a href="/terminal" class="nav-link {% if page == 'terminal' %}active{% endif %}">Terminal ⚡</a>
          <a href="/logs" class="nav-link {% if page == 'logs' %}active{% endif %}">Logs ⚡</a>
          <a href="/storage" class="nav-link {% if page == 'storage' %}active{% endif %}">Storage ⚡</a>
          <a href="/services" class="nav-link {% if page == 'services' %}active{% endif %}">Services ⚡</a>
          <a href="/services" class="nav-link">Docker ⚡</a>
        </div>
      </nav>
      <div class="side-actions">
        <button id="theme-toggle" class="ghost-btn">Theme</button>
        <button id="logout-btn" class="danger-btn">Logout</button>
      </div>
    </aside>
    <section class="content">
      <header class="topbar">
        <h2>{% block title %}Dashboard{% endblock %}</h2>
        <p id="top-status">Connected</p>
      </header>
      <script>
        window.__appReady = false;
        window.__appReadyQueue = [];
        window.onAppReady = function onAppReady(callback) {
          if (typeof callback !== 'function') return;
          if (window.__appReady) {
            callback();
            return;
          }
          window.__appReadyQueue.push(callback);
        };
      </script>
      <main>
        {% block content %}{% endblock %}
      </main>
    </section>
  </div>
  <div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>
  <script>
    function cookie(name) {
      const m = document.cookie.match('(^|;)\\s*' + name + '=([^;]+)');
      return m ? m.pop() : '';
    }

    window.toast = function toast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      if (!container || !message) return;
      const item = document.createElement('div');
      item.className = `toast toast-${type}`;
      item.textContent = String(message);
      container.appendChild(item);
      setTimeout(() => {
        item.classList.add('toast-hide');
        setTimeout(() => item.remove(), 220);
      }, 4000);
    };

    window.setButtonBusy = function setButtonBusy(button, busy, label) {
      if (!(button instanceof HTMLButtonElement)) return;
      if (busy) {
        if (!button.dataset.originalHtml) {
          button.dataset.originalHtml = button.innerHTML;
        }
        button.disabled = true;
        button.classList.add('is-busy');
        const text = label || button.dataset.busyLabel || 'Working...';
        button.innerHTML = `<span class="btn-spinner" aria-hidden="true"></span><span>${text}</span>`;
        return;
      }

      button.disabled = false;
      button.classList.remove('is-busy');
      if (button.dataset.originalHtml) {
        button.innerHTML = button.dataset.originalHtml;
        delete button.dataset.originalHtml;
      }
    };

    window.withBusyButton = async function withBusyButton(button, fn, label) {
      window.setButtonBusy(button, true, label);
      try {
        return await fn();
      } finally {
        window.setButtonBusy(button, false);
      }
    };

    window.api = async function api(path, options = {}) {
      const req = { ...options };
      req.headers = req.headers || {};
      const method = String(req.method || 'GET').toUpperCase();
      if (method !== 'GET' && method !== 'HEAD' && method !== 'OPTIONS') {
        req.headers['X-CSRF-Token'] = cookie('csrf_token');
      }

      const response = await fetch(path, req);
      if (response.status === 401) {
        window.location.href = '/';
        throw new Error('Session expired. Please log in again.');
      }

      const payload = await response.json().catch(() => ({}));
      if (!response.ok) {
        const msg = payload.detail || payload.message || 'Request failed';
        window.toast(msg, 'error');
        throw new Error(msg);
      }
      return payload;
    };

    window.createReconnectingWebSocket = function createReconnectingWebSocket(url, handlers = {}) {
      let socket = null;
      let reconnectTimer = null;
      let delayMs = 1000;
      let closedManually = false;

      const connect = () => {
        socket = new WebSocket(url);

        socket.onopen = (event) => {
          delayMs = 1000;
          if (handlers.onopen) handlers.onopen(event, socket);
        };
        socket.onmessage = (event) => {
          if (handlers.onmessage) handlers.onmessage(event, socket);
        };
        socket.onerror = (event) => {
          if (handlers.onerror) handlers.onerror(event, socket);
        };
        socket.onclose = (event) => {
          if (handlers.onclose) handlers.onclose(event, socket);
          if (closedManually) return;
          reconnectTimer = setTimeout(connect, delayMs);
          delayMs = Math.min(delayMs * 2, 30000);
        };
      };

      connect();

      return {
        close() {
          closedManually = true;
          if (reconnectTimer) clearTimeout(reconnectTimer);
          if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
            socket.close();
          }
        },
        send(data) {
          if (socket && socket.readyState === WebSocket.OPEN) socket.send(data);
        },
      };
    };

    (function initAdvancedNav() {
      const toggle = document.getElementById('advanced-toggle');
      const nav = document.getElementById('advanced-nav');
      const chevron = document.getElementById('advanced-chevron');
      if (!toggle || !nav || !chevron) return;

      const setExpanded = (expanded) => {
        nav.hidden = !expanded;
        toggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
        chevron.textContent = expanded ? '▾' : '▸';
      };

      setExpanded(false);
      toggle.addEventListener('click', () => {
        const expanded = toggle.getAttribute('aria-expanded') === 'true';
        setExpanded(!expanded);
      });
    })();

    window.__appReady = true;
    if (Array.isArray(window.__appReadyQueue)) {
      const queued = window.__appReadyQueue.slice();
      window.__appReadyQueue.length = 0;
      queued.forEach((callback) => {
        try {
          callback();
        } catch (error) {
          console.error(error);
        }
      });
    }
  </script>
  <script src="/static/js/router.js?v=20260220a"></script>
</body>
</html>
